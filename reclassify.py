import requests
import subprocess
import os
import re
import concurrent.futures
import time
from datetime import datetime, timedelta

def download_file(url):
    """下载原始文件"""
    print(f"正在下载文件: {url}")
    try:
        response = requests.get(url, timeout=30)
        response.raise_for_status()
        print(f"下载成功，文件大小: {len(response.text)} 字符")
        return response.text
    except Exception as e:
        print(f"下载失败: {e}")
        return None

def process_content(content):
    """处理内容"""
    if not content:
        print("内容为空，无法处理")
        return []
        
    lines = content.split('\n')
    print(f"原始文件行数: {len(lines)}")
    
    # 1. 删除前两行
    if len(lines) >= 2:
        lines = lines[2:]
        print(f"删除前两行后行数: {len(lines)}")
    else:
        print("文件行数不足，无法删除前两行")
        return []
    
    # 只返回非空行
    non_empty_lines = [line for line in lines if line.strip()]
    print(f"非空行数: {len(non_empty_lines)}")
    
    # 打印前几行作为示例
    if non_empty_lines:
        print("前5行示例:")
        for i in range(min(5, len(non_empty_lines))):
            print(f"  {i+1}: {non_empty_lines[i]}")
    
    return non_empty_lines

def parse_groups(lines):
    """解析分组"""
    groups = {}
    current_group = None
    
    print("开始解析分组...")
    
    for line in lines:
        line = line.strip()
        if not line:
            continue
            
        # 检查是否是分组行
        if line.endswith(',#genre#'):
            # 提取组名并删除"-组播"字符串
            group_name = line.split(',')[0]
            # 删除组名中的"-组播"字符串
            group_name = group_name.replace('-组播', '')
            current_group = group_name
            groups[current_group] = []
            print(f"找到分组: {group_name}")
        elif current_group and ',' in line:
            # 频道行：频道名称,播放地址
            parts = line.split(',', 1)
            if len(parts) == 2:
                channel_name, channel_url = parts
                groups[current_group].append((channel_name, channel_url))
    
    print(f"共解析出 {len(groups)} 个分组")
    
    # 打印分组统计
    for group_name, channels in groups.items():
        print(f"分组 '{group_name}' 有 {len(channels)} 个频道")
    
    return groups

def check_stream(url, timeout=8):
    """
    使用ffprobe检查流有效性 - 优化版本
    """
    print(f"  检测流: {url}")
    
    try:
        # 使用更宽松的参数检测流
        result = subprocess.run(
            [
                "ffprobe", 
                "-v", "quiet",
                "-probesize", "32",
                "-analyzeduration", "1000000",  # 1秒
                "-select_streams", "v:0",  # 只检测视频流
                "-show_entries", "stream=codec_type",
                "-of", "csv=p=0",
                "-i", url
            ],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            timeout=timeout
        )
        
        # 检查返回码和输出
        if result.returncode == 0:
            # 检查输出中是否包含视频流
            output = result.stdout.decode('utf-8', errors='ignore').strip()
            is_valid = "video" in output.lower()
            
            if is_valid:
                print(f"    ✓ 流有效")
            else:
                print(f"    ✗ 流无效 - 无视频流")
                if result.stderr:
                    error_msg = result.stderr.decode('utf-8', errors='ignore')[:200]
                    print(f"    错误信息: {error_msg}")
            
            return is_valid
        else:
            print(f"    ✗ 流无效 - 返回码: {result.returncode}")
            if result.stderr:
                error_msg = result.stderr.decode('utf-8', errors='ignore')[:200]
                print(f"    错误信息: {error_msg}")
            return False
        
    except subprocess.TimeoutExpired:
        print(f"    ✗ 检测超时 ({timeout}秒)")
        return False
    except FileNotFoundError:
        print(f"    ✗ 未找到ffprobe，请安装ffmpeg")
        return False
    except Exception as e:
        print(f"    ✗ 检测异常: {e}")
        return False

def check_group_validity(group_name, channels, timeout=8):
    """检查分组有效性 - 优化版本"""
    if not channels:
        print(f"分组 '{group_name}' 没有频道，跳过")
        return False
    
    # 尝试检测前3个频道，只要有一个有效就认为分组有效
    print(f"检测分组 '{group_name}' 的频道...")
    
    valid_count = 0
    tested_count = min(3, len(channels))  # 最多测试3个频道
    
    for i in range(tested_count):
        channel_name, channel_url = channels[i]
        print(f"  测试频道 {i+1}/{tested_count}: {channel_name}")
        
        is_valid = check_stream(channel_url, timeout)
        if is_valid:
            valid_count += 1
            print(f"  ✓ 频道有效，分组标记为有效")
            break  # 只要有一个有效就认为分组有效
        else:
            print(f"  ✗ 频道无效")
    
    is_group_valid = valid_count > 0
    
    if is_group_valid:
        print(f"✓ 分组 '{group_name}' 有效，保留")
    else:
        print(f"✗ 分组 '{group_name}' 无效，删除")
    
    return is_group_valid

def filter_valid_groups(groups, max_workers=5):
    """使用多线程过滤有效的分组"""
    valid_groups = {}
    
    print("开始多线程检测流有效性...")
    
    # 准备检测任务
    tasks = []
    for group_name, channels in groups.items():
        if channels:  # 只检测有频道的分组
            tasks.append((group_name, channels))
    
    print(f"共有 {len(tasks)} 个分组需要检测")
    
    # 使用线程池并行检测
    with concurrent.futures.ThreadPoolExecutor(max_workers=max_workers) as executor:
        # 提交所有检测任务
        future_to_group = {
            executor.submit(check_group_validity, group_name, channels): group_name 
            for group_name, channels in tasks
        }
        
        # 收集结果
        for future in concurrent.futures.as_completed(future_to_group):
            group_name = future_to_group[future]
            try:
                is_valid = future.result()
                if is_valid:
                    valid_groups[group_name] = groups[group_name]
            except Exception as e:
                print(f"检测分组 '{group_name}' 时发生异常: {e}")
    
    print(f"有效性检测完成，有效分组: {len(valid_groups)} 个")
    return valid_groups

def load_category_mapping():
    """加载频道分类映射 - 完整版本"""
    # 完整的分类映射
    CATEGORY_MAPPING = {
        "央视频道,#genre#": [
            "CCTV-1综合","CCTV-2财经","CCTV-3综艺","CCTV-4中文国际","CCTV-5体育","CCTV-5+体育赛事",
            "CCTV-6电影","CCTV-7国防军事","CCTV-8电视剧","CCTV-9纪录","CCTV-10科教","CCTV-11戏曲",
            "CCTV-12社会与法","CCTV-13新闻","CCTV-14少儿","CCTV-15音乐","CCTV-16奥林匹克",
            "CCTV-16奥林匹克4K","CCTV-17农业农村","CCTV-4欧洲","CCTV-4美洲","CCTV-4K","CCTV-8K",
            "中央新影-中学生","中央新影-老故事","中央新影-发现之旅","CGTN","CGTN-纪录","CGTN-法语",
            "CGTN-俄语","CGTN-西班牙语","CGTN-阿拉伯语","中国教育1台","中国教育2台","中国教育4台","早期教育"
        ],
        "付费频道,#genre#": [
            "CCTV风云剧场","CCTV怀旧剧场","CCTV第一剧场","CCTV风云足球","CCTV央视台球",
            "CCTV高尔夫·网球","CCTV风云音乐","CCTV央视文化精品","CCTV卫生健康","CCTV电视指南",
            "CCTV兵器科技","CCTV女性时尚","CCTV世界地理","CHC家庭影院","CHC动作电影","CHC影迷电影"
        ],
        "卫视频道,#genre#": [
            "山东卫视","北京卫视","东方卫视","重庆卫视","江苏卫视","浙江卫视","江西卫视","安徽卫视",
            "湖南卫视","湖北卫视","河南卫视","河北卫视","广东卫视","广西卫视","深圳卫视","大湾区卫视",
            "东南卫视","海南卫视","四川卫视","贵州卫视","云南卫视","天津卫视","辽宁卫视","黑龙江卫视",
            "吉林卫视","内蒙古卫视","宁夏卫视","山西卫视","陕西卫视","甘肃卫视","青海卫视","新疆卫视",
            "西藏卫视","三沙卫视","兵团卫视","延边卫视","安多卫视","康巴卫视","农林卫视","海峡卫视",
            "山东教育卫视","西藏卫视藏语","安多卫视藏语","康巴卫视藏语","内蒙古卫视蒙语",
            "北京卫视4K","广东卫视4K","深圳卫视4K","山东卫视4K","湖南卫视4K","浙江卫视4K",
            "江苏卫视4K","东方卫视4K","四川卫视4K"
        ],
        "国际频道,#genre#": [
            "凤凰卫视","凤凰资讯","凤凰香港","凤凰电影","星空卫视","Channel[V]"
        ],
        "山东频道,#genre#": [
            "山东齐鲁频道","山东体育频道","山东农科频道","山东新闻频道","山东少儿频道","山东文旅频道",
            "山东综艺频道","山东生活频道","山东居家购物","济南新闻综合","济南教育频道","济南娱乐",
            "济南少儿","济南影视","济南生活","济南都市","济南鲁中","济宁综合频道","宁阳综合频道",
            "潍坊新闻综合","潍坊经济生活","东平综合频道","乳山综合频道","兖州新闻频道","兰陵综合频道",
            "夏津公共频道","夏津综合频道","宁津综合频道","安丘综合频道","烟台影视频道","烟台新闻综合",
            "烟台经济科技","禹城综合频道","禹城综艺频道","聊城民生频道","聊城综合频道","茌平综合频道",
            "荣成综合频道","莘县综合频道","莱西综合频道","定陶TV-1","文登TV-1","邹城综合频道",
            "郓城综合频道","阳信新闻综合","陵城综合频道","青州文化旅游","青州综合频道","齐河新闻频道",
            "巨野新闻频道","平原综合频道","平度新闻综合","平阴综合频道","德州经济生活","德州新闻综合",
            "新泰乡村频道","新泰综合频道","昌乐综合频道","昌邑综合频道","曲阜综合频道","梁山综合频道",
            "武城综艺影视","武城综合频道","沾化综合频道","淄博影视频道","淄博新闻综合","新闻综合",
            "无棣综合频道","日照岚山频道","蒙阴综合频道","单县综合频道","济阳综合频道","滨州综合频道",
            "青岛1","青岛2","青岛3","青岛4","青岛5","青岛6","烟台公共","宁阳2","菏泽2","济宁公共",
            "济宁生活","沂源新闻","淄博生活","淄博都市","东明1","东营公共","东营新闻","冠县综合",
            "寿光蔬菜","惠民综合","日照新闻","日照科教","栖霞综合","桓台综合","滨州公共","滨州新闻",
            "潍坊寿光新闻","牟平新闻","牟平生活","菏泽1","诸城新闻","长清新闻"
        ],
        "北京频道,#genre#": [
            "北京IPTV4K超清","北京IPTV淘电影","北京IPTV淘剧场","北京IPTV淘精彩","北京IPTV淘娱乐",
            "北京IPTV淘BABY","北京IPTV萌宠TV","北京IPTV重温经典","北京纪实科教","北京卡酷少儿",
            "北京体育休闲","北京文艺频道","北京影视频道","北京财经频道","北京生活频道","北京新闻频道",
            "北京青年","北京国际频道","朝阳区","通州区","门头沟区","房山区","密云区","延庆区"
        ],
        "上海频道,#genre#": [
            "新视觉","上海新闻综合","上海第一财经","上海东方财经","上海东方影视","上海哈哈炫动",
            "上海五星体育","上海劲爆体育","上海都市频道","上海教育教育","上海纪实人文","上海都市剧场",
            "上海都市剧场4K","上海欢笑剧场","上海欢笑剧场4K","上海动漫秀场","上海动漫秀场4K",
            "上海乐游频道","上海法治天地","上海金色学堂","上海游戏风云","上海生活时尚"
        ],
        "广东频道,#genre#": [
            "广东体育频道","广东珠江频道","广东新闻频道","广东民生频道","广东经济科教","广东影视频道",
            "广东少儿频道","广东嘉佳卡通","广东综艺4K","广东4K超高清","广东岭南戏曲","广州综合频道",
            "广州新闻频道","广州影视频道","广州法治频道","南国都市4K","深圳都市频道","深圳电视剧频道",
            "深圳财经生活","深圳体育健康","深圳少儿频道","宝安频道","深圳龙岗频道","佛山公共频道",
            "佛山南海频道","佛山顺德频道","佛山影视频道","佛山综合频道","东莞新闻综合","东莞生活资讯",
            "韶关新闻综合","湛江新闻综合","湛江公共频道","揭阳综合频道","揭阳生活频道","汕尾新闻综合",
            "汕尾文化生活","江门综合频道","江门侨乡生活","潮州综合频道","潮州民生频道","惠州综合频道",
            "惠州公共频道","珠海-1","肇庆综合频道","肇庆生活服务","河源综合频道","河源公共频道",
            "清远新闻综合","清远文旅生活","云浮综合频道","云浮文旅频道","茂名综合频道","茂名文化生活",
            "汕头综合频道","汕头经济生活","中山综合频道","香山文化频道","广东现代教育","广东南方购物",
            "河源生活频道"
        ],
        "内蒙古频道,#genre#": [
            "内蒙古蒙语频道","内蒙古经济生活","内蒙古新闻综合","内蒙古文体娱乐","内蒙古农牧频道",
            "内蒙古少儿频道","呼市新闻综合","包头经济频道","包头生活服务","包头新闻综合","乌海新闻综合",
            "乌海都市生活","赤峰新闻综合","赤峰经济服务","赤峰影视娱乐","通辽城市服务","通辽新闻综合",
            "通辽蒙语频道","呼伦贝尔新闻综合","呼伦贝尔文化旅游","呼伦贝尔生活资讯","巴彦淖尔新闻综合",
            "巴彦淖尔经济生活","巴彦淖尔影视娱乐","鄂尔多斯新闻综合","鄂尔多斯经济服务","鄂尔多斯蒙语频道",
            "锡林郭勒1","锡林郭勒2","杭后电视台","达茂电视台","库伦电视台","丰镇电视台","突泉电视台",
            "阿尔山电视台","托克托电视台","额济纳新闻综合","西乌电视台","准格尔综合频道","伊金霍洛旗综合",
            "苏尼特左旗","苏尼特右旗","乌拉特前旗","乌拉特中旗","乌拉特后旗","乌盟经济生活","乌盟新闻综合",
            "兴安新闻综合","兴安文化旅游","兴安影视娱乐","阿拉善新闻综合","XHTV","ELTV","五原","磴口",
            "武川","扎兰屯","阿巴嘎","翁牛特","满洲里","阿右旗","正蓝旗","东乌旗","土左旗","太仆寺旗",
            "科右中旗","正镶白旗","扎赉特旗","察右中旗","喀喇沁县","额尔古纳","和林格尔","克什克腾旗",
            "内蒙古购物"
        ],
        "云南频道,#genre#": [
            "云南都市频道","云南娱乐频道","云南影视频道","云南康旅频道","云南少儿频道","澜湄国际频道",
            "云南4K频道","楚雄新闻频道","禄丰市电视台"
        ],
        "吉林频道,#genre#": [
            "长影频道","吉林教育","吉林篮球","扶余电视台","延边TV1","延边TV2","TTV洮南1","农安综合",
            "吉林科教","辽源新闻综合","辽源民生社会","松原综合频道","松原生活频道","白山新闻综合1",
            "白山旅游生活2","四平1","四平2","TTV1","TTV2","TTV3","磐石综合频道","图门电视台","双辽",
            "梅河口电视台","DFTV综合","乾安综合"
        ],
        "四川频道,#genre#": [
            "四川经济频道","四川文化旅游","四川新闻频道","四川影视文艺","四川星空购物","四川妇女儿童",
            "四川科教频道","四川乡村频道","四川峨眉电影","成都综合频道","成都经济频道","成都生活频道",
            "成都影视频道","成都公共频道","成都少儿频道","蓉城先锋"
        ],
        "天津频道,#genre#": [
            "天津新闻频道","天津文艺频道","天津影视频道","天津都市频道","天津体育频道","天津教育频道",
            "天津少儿频道","天津文旅频道","天津购物频道","蓟州电视台","滨海1","滨海2","静海电视台",
            "河东频道","河西频道","保定电视台","大港油田企业"
        ],
        "宁夏频道,#genre#": [
            "宁夏公共频道","宁夏教育频道","宁夏经济频道","宁夏少儿频道","宁夏文旅频道","银川公共频道",
            "银川生活频道","银川文体频道"
        ],
        "安徽频道,#genre#": [
            "安徽经济生活","安徽影视频道","安徽农业科教","安徽国际频道","安徽公共频道","安徽综艺体育",
            "合肥新闻频道","肥西新闻综合","黄山新闻综合","黄山文旅频道","旌德新闻综合","霍邱新闻综合",
            "六安综合频道","六安社会生活","淮北新闻综合","淮北经济生活","淮南新闻综合","淮南民生频道",
            "滁州新闻综合","滁州科教频道","滁州公共频道","蒙城新闻频道","南陵新闻综合","祁门综合频道",
            "湾沚综合频道","繁昌新闻综合","桐城综合频道","太湖新闻综合","池州新闻综合","池州文教生活",
            "义安新闻综合","阜阳新闻综合","阜阳生活频道","阜阳教育频道","阜阳都市文艺","泗县新闻频道",
            "临泉新闻频道","阜南新闻综合","亳州综合频道","亳州农村频道","徽州新闻频道","蚌埠新闻综合",
            "蚌埠生活频道","寿县新闻综合","屯溪融媒频道","芜湖新闻综合","芜湖生活频道","无为新闻频道",
            "马鞍山新闻综合","马鞍山科教生活","安庆新闻综合","安庆经济生活","潜山综合频道","黄山区融媒",
            "歙县综合频道","休宁新闻综合","黟县综合频道","宣城综合频道","宣城文旅生活","广德新闻综合",
            "广德生活频道","郎溪新闻频道","宁国新闻综合","铜陵新闻综合","铜陵教育科技","枞阳电视台",
            "霍山综合频道","金寨综合频道","濉溪新闻频道","宿州新闻综合","宿州公共频道","宿州科教频道",
            "萧县新闻综合","五河新闻综合","固镇新闻综合","界首综合频道","利辛新闻综合","涡阳新闻综合"
        ],
        "山西频道,#genre#": [
            "黄河电视台","山西经济与科技","山西影视","山西社会与法治","山西文体生活","晋中综合频道",
            "晋中公共频道","运城1台","运城2台","盐湖频道","清徐","朔州-1","朔州-2","孝义电视台",
            "古交电视台","阳曲","太原1","太原2","太原3","太原4","太原5","太原教育","晋能控股","大同教育",
            "阳泉-1新闻综合","阳泉-2科教"
        ],
        "广西频道,#genre#": [
            "广西综艺旅游","广西影视频道","广西新闻频道","广西都市频道","广西国际频道","广西移动电视",
            "南宁新闻综合","南宁影视娱乐","南宁公共频道","南宁文旅生活","柳州新闻","北海新闻","玉林新闻",
            "贺州新闻","桂林新闻"
        ],
        "新疆频道,#genre#": [
            "XJTV-1","XJTV-2","XJTV-3","XJTV-4","XJTV-5","XJTV-6","XJTV-7","XJTV-8","包头TV1","包头TV2",
            "包头TV3","乌鲁木齐1","阿克苏1","阿克苏2","阿拉尔","阿勒泰1","克孜勒苏柯尔克孜1",
            "克孜勒苏柯尔克孜2","克孜勒苏柯尔克孜3","伊犁哈萨克1","伊犁哈萨克2","伊犁哈萨克3","伊犁哈萨克4",
            "喀什1","喀什2","喀什3","巴音郭楞1","巴音郭楞2","巴音郭楞3","巴音郭楞4","昌吉市电视台",
            "霍城1","呼图壁1","玛纳斯1","竹山1","竹山2","奎屯1","奎屯3","哈密TV1","哈密TV3"
        ],
        "江苏频道,#genre#": [
            "江苏城市频道","江苏综艺频道","江苏体育休闲","江苏影视频道","江苏优漫卡通","江苏新闻频道",
            "江苏教育频道","江苏国际频道","江苏财富天下","南京新闻综合","南京科教频道","南京生活频道"
        ],
        "江西频道,#genre#": [
            "江西都市频道","江西经济生活","江西影视旅游","江西公共农业","江西少儿频道","江西新闻频道",
            "江西教育频道"
        ],
        "河北频道,#genre#": [
            "河北经济生活","河北都市频道","河北影视剧频道","河北少儿科教","河北文旅公共","河北农民",
            "睛彩河北","河北杂技频道","河北三佳购物","石家庄新闻综合","石家庄文化娱乐","石家庄城市服务",
            "承德新闻综合","承德旅游文化","秦皇岛新闻综合","秦皇岛公共频道","秦皇岛影视","唐山新闻综合",
            "唐山生活服务","唐山影视频道","唐山公共频道","廊坊新闻综合","廊坊生活频道","保定新闻综合",
            "保定公共频道","保定生活健康","衡水新闻综合","衡水经济科教","邢台综合频道","邢台城市生活",
            "邯郸新闻综合","邯郸公共频道","邯郸科技教育","高邑融媒","井陉矿区电视台","深泽综合频道",
            "赵县综合频道","晋州综合频道","井陉综合频道","平泉综合频道","兴隆综合频道","隆化综合频道",
            "崇礼电视台","康保综合频道","遵化综合频道","三河综合频道","永清综合频道","成安综合频道",
            "魏县综合新闻","滦南综合频道","玉田综合频道","吴桥综合频道","阜平电视台","涞水综合频道",
            "黄骅电视台","定州新闻综合","雄县电视台","涞源综合频道","高碑店综合频道","涿州综合频道",
            "唐县综合频道","曲阳综合频道","柏乡综合频道","徐水电视台","景县综合频道","饶阳电视台",
            "深州新闻综合","涉县综合频道","鸡泽新闻综合","武安新闻综合","枣强综合频道","清河电视台",
            "大厂融媒体中心","顺平电视","赤城电视","邯山电视","任县电视","双滦电视","滦平电视","赞皇电视",
            "栾城电视","张家口新闻综合","张家口公共","沧州新闻综合","沧州公共频道","沧州影视娱乐",
            "昌黎电视","抚宁电视","卢龙电视","丰南电视","迁西电视","滦州电视","香河电视","大城电视",
            "固安电视","霸州电视","孟村电视","东光电视","青县电视","盐山电视","南皮电视","肃宁电视",
            "丰宁电视","定兴电视","满城电视","望都电视","高阳电视","安新电视","容城电视","涿鹿电视",
            "大名电视","冀州电视","安平电视","阜城电视","故城电视","广宗电视","宁晋电视","平乡电视",
            "隆尧电视","广平电视","南和电视","临漳电视台","内丘电视台","迁安电视","馆陶电视","乐亭电视",
            "沙河电视","南宫电视","丰润电视"
        ],
        "河南频道,#genre#": [
            "河南都市频道","河南民生频道","河南法治频道","河南电视剧频道","河南新闻频道","河南乡村频道",
            "河南戏曲频道","河南收藏天下","河南中华功夫","河南移动电视","河南欢腾购物","河南调解剧场",
            "河南移动戏曲","河南睛彩中原","河南IPTV导视","郑州1新闻综合","郑州2商都频道","郑州3文体旅游",
            "郑州4豫剧频道","郑州5妇女儿童","郑州6都市生活","洛阳-1新闻综合","洛阳-2科教频道",
            "洛阳-3文旅频道","南阳1新闻综合","南阳2公共频道","南阳3科教频道","周口公共频道","周口教育频道",
            "周口新闻综合","开封1新闻综合","开封2文化旅游","新乡公共频道","新乡新闻综合","焦作公共频道",
            "焦作综合频道","漯河新闻综合","信阳新闻综合","信阳文旅频道","封丘1新闻综合","叶县电视台-1",
            "新密综合频道","登封综合频道","巩义综合频道","新郑TV-1","渑池新闻综合","淅川电视台-1",
            "新蔡TV","镇平新闻综合","宝丰TV-1","义马综合频道","鹤壁新闻综合","安阳新闻综合",
            "三门峡新闻综合","卫辉综合频道","孟津综合综合","安阳文旅频道","淇县电视台","宜阳综合频道",
            "汝阳综合频道","原阳电视台","宝丰-1","内黄综合频道","郏县综合频道","禹州电视台","杞县新闻综合",
            "永城新闻联播","光山综合频道","商丘1新闻综合","商丘2公共频道","商丘3文体科教","许昌农业科教",
            "许昌综合频道","平顶山新闻综合","平顶山城市频道","平顶山公共频道","平顶山教育台","新乡综合频道",
            "邓州综合频道","获嘉综合频道","平煤安全环保","荥阳综合频道","健康河南融媒","灵宝综合频道",
            "渑池新闻综合","济源-1","濮阳新闻综合","濮阳公共频道","新县综合频道","延津电视台","大象新闻",
            "大剧院","舞钢电视台-1","嵩县综合新闻","浉河广电中心","平桥广电中心","郸城","唐河TV-1",
            "上蔡-1","舞阳新闻综合","临颍综合频道","项城电视台"
        ],
        "浙江频道,#genre#": [
            "浙江钱江频道","浙江经济生活","浙江教育频道","浙江民生休闲","浙江新闻频道","浙江少儿频道",
            "浙江之江纪录","杭州综合","杭州明珠","杭州生活","杭州影视","杭州青少","杭州导视","宁波新闻综合",
            "宁波生活频道","宁波文体频道","宁波影视频道","温州新闻综合","绍兴新闻综合","衢州新闻综合",
            "衢州公共频道","湖州新闻","金华新闻","丽水新闻","嘉兴新闻","桐乡新闻","中国蓝直播"
        ],
        "海南频道,#genre#": [
            "海南公共频道","海南少儿频道","海南文旅频道","海南新闻频道","海南自贸频道","海口1台",
            "海口2台","海口3台","白沙TV","保亭TV","澄迈TV","儋州TV","定安TV","东方TV","临高","陵水TV",
            "琼海TV","琼中TV","三亚1台","乐东TV","屯昌TV","昌江TV","万宁综合","文昌TV","五指山TV"
        ],
        "湖北频道,#genre#": [
            "湖北公共新闻","湖北经视频道","湖北综合频道","湖北垄上频道","湖北影视频道","湖北生活频道",
            "湖北教育频道","武汉新闻综合","武汉电视剧","武汉科技生活","武汉文体频道","武汉教育频道",
            "阳新综合","房县综合","蔡甸综合"
        ],
        "湖南频道,#genre#": [
            "湖南卫视FHD","金鹰卡通FHD","金鹰纪实FHD","快乐垂钓FHD","湖南经视FHD","湖南都市FHD",
            "湖南国际FHD","湖南公共FHD","湖南娱乐FHD","湖南电影FHD","湖南电视剧FHD","湖南经视频道",
            "湖南都市频道","湖南国际频道","湖南公共频道","湖南娱乐频道","湖南电影频道","湖南电视剧频道",
            "长沙新闻综合","长沙政法频道","长沙文旅频道","益阳新闻综合","益阳公共频道","岳阳新闻综合",
            "岳阳文旅都市","张家界1新闻综合","张家界2公共频道","湘西新闻综合","湘西文化旅游","株洲新闻综合",
            "永州新闻综合","永州经济生活","湘潭新闻综合","湘潭县电视台","衡阳新闻综合","衡阳文旅法治",
            "衡阳县电视台","邵阳新闻综合","邵阳文旅民生","郴州综合频道","郴州公共频道","怀化新闻综合",
            "常德新闻综合","常德公共频道","娄底综合频道","娄底公共频道","娄底教育频道","东安新闻综合",
            "桃源综合频道","双牌新闻综合","麻阳综合频道","宁远综合频道","汨罗综合频道","新化电视台",
            "津市电视台","武冈综合频道","江永新闻频道","洪江新闻频道","涟源综合频道","溆浦综合频道",
            "蓝山综合频道","新田综合频道","道县综合频道","中方台","桂东融媒"
        ],
        "甘肃频道,#genre#": [
            "甘肃文化影视","甘肃公共频道","甘肃科教频道","甘肃经济频道","甘肃少儿频道","陇尚生活",
            "临夏新闻综合","临夏文旅频道","皋兰电视台"
        ],
        "福建频道,#genre#": [
            "福建综合频道","福建公共频道","福建新闻频道","福建电视剧频道","福建经济频道","福建文体频道",
            "福建少儿频道","福建教育频道","福建旅游频道","厦门一套","平潭卫视","龙岩综合频道","福州新闻",
            "泉州一套","莆田新闻"
        ],
        "贵州频道,#genre#": [
            "贵州公共频道","贵州影视文艺","贵州大众生活","贵州法制频道","贵州科教健康","贵州经济频道",
            "贵州移动电视","贵阳-1","贵阳-2","贵阳-3","六盘水-1","六盘水-2","黔南-1","黔南-2",
            "黔西南综合频道","黔西南公共频道","黔西-1","黔东南综合频道","遵义综合频道","遵义公共频道",
            "遵义都市频道","铜仁-1","铜仁-2","毕节-1","毕节-2","安顺新闻综合","安顺公共频道","瓮安电视台",
            "思南综合频道","凯里TV","雷山综合频道","贵州直播频道"
        ],
        "辽宁频道,#genre#": [
            "辽宁都市频道","辽宁影视剧频道","辽宁体育休闲","辽宁生活频道","辽宁教育青少","辽宁北方频道",
            "辽宁公共频道","辽宁经济频道","沈阳新闻综合","辽河新闻综合","辽河文化生活"
        ],
        "重庆频道,#genre#": [
            "重庆新闻频道","重庆影视剧频道","重庆社会与法","重庆红岩文化","重庆文体娱乐","重庆新农村",
            "重庆融媒","重庆少儿频道","重庆红叶频道","重庆汽摩频道","重庆移动频道","开州综合"
        ],
        "陕西频道,#genre#": [
            "陕西新闻资讯","陕西都市青春","陕西体育休闲","陕西西部电影","陕西秦腔频道","陕西银铃频道",
            "西安新闻综合","西安都市频道","西安商务资讯","西安戏剧影视","西安丝路频道","西安教育频道",
            "西安乐购购物"
        ],
        "青海频道,#genre#": [
            "青海都市","青海经视","西宁新闻综合","西宁生活服务","海东综合频道","海北电视台","海西电视台",
            "久治","青海油田","矿区生活"
        ],
        "黑龙江频道,#genre#": [
            "黑龙江影视频道","黑龙江新闻法治","黑龙江少儿频道","黑龙江文体频道","黑龙江农业科教",
            "黑龙江都市频道","哈尔滨新闻综合","哈尔滨生活频道","哈尔滨影视频道","齐齐哈尔新闻综合",
            "齐齐哈尔经济法治","佳木斯新闻综合"
        ],
        "其他频道,#genre#": []
    }

    # 简化的频道名称映射
    CHANNEL_NAME_MAPPING = {
        "CCTV-1综合": ["CCTV-1综合"],
        "CCTV-2财经": ["CCTV-2财经"],
        "CCTV-3综艺": ["CCTV-3综艺"],
        "CCTV-4中文国际": ["CCTV-4中文国际"],
        "CCTV-5体育": ["CCTV-5体育"],
        "CCTV-5+体育赛事": ["CCTV-5+体育赛事","CCTV5+体育赛事"],
        "CCTV-6电影": ["CCTV-6电影"],
        "CCTV-7国防军事": ["CCTV-7国防军事"],
        "CCTV-8电视剧": ["CCTV-8电视剧"],
        "CCTV-9纪录": ["CCTV-9纪录"],
        "CCTV-10科教": ["CCTV-10科教"],
        "CCTV-11戏曲": ["CCTV-11戏曲"],
        "CCTV-12社会与法": ["CCTV-12社会与法"],
        "CCTV-13新闻": ["CCTV-13新闻"],
        "CCTV-14少儿": ["CCTV-14少儿"],
        "CCTV-15音乐": ["CCTV-15音乐"],
        "CCTV-16奥林匹克": ["CCTV-16奥林匹克"],
        "CCTV-16奥林匹克4K": ["CCTV-16奥林匹克4K"],
        "CCTV-17农业农村": ["CCTV-17农业农村"],
        "CCTV-4欧洲": ["CCTV4欧洲","CCTV-4欧洲","CCTV4欧洲 HD","CCTV-4 欧洲","CCTV-4中文国际欧洲","CCTV-4中文国际 欧洲"],
        "CCTV-4美洲": ["CCTV4美洲","CCTV-4北美","CCTV4美洲 HD","CCTV-4 美洲","CCTV-4中文国际美洲","CCTV-4中文国际 美洲"],
        "CCTV-4K": ["CCTV4K超高清","CCTV4K","CCTV-4K超高清","CCTV 4K","CCTV4K超"],
        "CCTV-8K": ["CCTV8K超高清","CCTV8K","CCTV-8K超高清","CCTV 8K"],
        "CCTV兵器科技": ["CCTV-兵器科技","CCTV兵器科技","兵器科技"],
        "CCTV风云音乐": ["CCTV-风云音乐","CCTV风云音乐","风云音乐"],
        "CCTV第一剧场": ["CCTV-第一剧场","CCTV第一剧场","第一剧场"],
        "CCTV风云足球": ["CCTV-风云足球","CCTV风云足球","风云足球"],
        "CCTV风云剧场": ["CCTV-风云剧场","CCTV风云剧场","风云剧场"],
        "CCTV怀旧剧场": ["CCTV-怀旧剧场","CCTV怀旧剧场","怀旧剧场"],
        "CCTV女性时尚": ["CCTV-女性时尚","CCTV女性时尚","女性时尚"],
        "CCTV世界地理": ["CCTV-世界地理","CCTV世界地理","世界地理"],
        "CCTV央视台球": ["CCTV-央视台球","CCTV央视台球","央视台球"],
        "CCTV高尔夫·网球": ["CCTV-高尔夫网球","CCTV高尔夫网球","CCTV央视高网","CCTV-高尔夫·网球","央视高网","高尔夫网球"],
        "CCTV央视文化精品": ["CCTV-央视文化精品","CCTV央视文化精品","CCTV文化精品","CCTV-文化精品","文化精品","央视文化精品"],
        "CCTV卫生健康": ["CCTV-卫生健康","CCTV卫生健康","卫生健康"],
        "CCTV电视指南": ["CCTV-电视指南","CCTV电视指南","电视指南"],
        "中国教育1台": ["CETV1","中国教育一台","中国教育1","CETV-1 综合教育","CETV-1"],
        "中国教育2台": ["CETV2","中国教育二台","中国教育2","CETV-2 空中课堂","CETV-2"],
        "中国教育3台": ["CETV3","中国教育三台","中国教育3","CETV-3 教育服务","CETV-3"],
        "中国教育4台": ["CETV4","中国教育四台","中国教育4","CETV-4 职业教育","CETV-4"],
        "早期教育": ["中国教育5台","中国教育5","中国教育五台","CETV早期教育","早期教育","CETV 早期教育","CETV-5","CETV5"],
        "CGTN": ["CGTN英语","CGTN-英语"],
        "CGTN-纪录": ["CGTN纪录","CGTN-纪录","CGTN记录","CGTN记录片"],
        "CGTN-西班牙语": ["CGTN-西班牙语","CGTN西班牙语","CGTN西语"],
        "CGTN-法语": ["CGTN-法语","CGTN法语"],
        "CGTN-俄语": ["CGTN-俄语","CGTN俄语"],
        "CGTN-阿拉伯语": ["CGTN-阿拉伯语","CGTN阿拉伯语"],
        "湖南卫视4K": ["湖南卫视4K"],
        "北京卫视4K": ["北京卫视4K","北京卫视4K超高清","北京卫视4K超"],
        "东方卫视4K": ["东方卫视4K"],
        "广东卫视4K": ["广东卫视4K"],
        "深圳卫视4K": ["深圳卫视4K"],
        "山东卫视4K": ["山东卫视4K"],
        "四川卫视4K": ["四川卫视4K"],
        "浙江卫视4K": ["浙江卫视4K"],
        "山东卫视": ["山东卫视"],
        "北京卫视": ["北京卫视"],
        "东方卫视": ["东方卫视"],
        "重庆卫视": ["重庆卫视"],
        "江苏卫视": ["江苏卫视"],
        "浙江卫视": ["浙江卫视"],
        "江西卫视": ["江西卫视"],
        "安徽卫视": ["安徽卫视"],
        "湖南卫视": ["湖南卫视"],
        "湖北卫视": ["湖北卫视"],
        "河南卫视": ["河南卫视"],
        "河北卫视": ["河北卫视"],
        "广东卫视": ["广东卫视"],
        "广西卫视": ["广西卫视"],
        "深圳卫视": ["深圳卫视"],
        "大湾区卫视": ["大湾区卫视"],
        "东南卫视": ["东南卫视"],
        "海南卫视": ["海南卫视"],
        "四川卫视": ["四川卫视"],
        "贵州卫视": ["贵州卫视"],
        "云南卫视": ["云南卫视"],
        "天津卫视": ["天津卫视"],
        "辽宁卫视": ["辽宁卫视"],
        "黑龙江卫视": ["黑龙江卫视"],
        "吉林卫视": ["吉林卫视"],
        "内蒙古卫视": ["内蒙古卫视"],
        "宁夏卫视": ["宁夏卫视"],
        "山西卫视": ["山西卫视"],
        "陕西卫视": ["陕西卫视"],
        "甘肃卫视": ["甘肃卫视"],
        "青海卫视": ["青海卫视"],
        "西藏卫视": ["西藏卫视"],
        "三沙卫视": ["三沙卫视","海南三沙卫视"],
        "兵团卫视": ["兵团卫视","新疆兵团卫视"],
        "延边卫视": ["延边卫视","吉林延边卫视"],
        "海峡卫视": ["海峡卫视","福建海峡卫视"],
        "农林卫视": ["农林卫视","陕西农林卫视"],
        "安多卫视": ["安多卫视","青海安多卫视"],
        "康巴卫视": ["康巴卫视","四川康巴卫视"],
        "西藏卫视藏语": ["西藏卫视（藏语）","西藏卫视藏语","西藏藏语频道"],
        "安多卫视藏语": ["安多藏语综合"],
        "康巴卫视藏语": ["康巴藏语综合"],
        "内蒙古卫视蒙语": ["内蒙古卫视（蒙语）"],
        "山东教育卫视": ["山东教育", "教育卫视"],
        "CHC影迷电影": ["CHC高清电影", "CHC-影迷电影", "影迷电影", "chc高清电影"],
        "CHC动作电影": ["CHC动作电影","CHC-动作电影"],
        "CHC家庭影院": ["CHC家庭影院","CHC-家庭影院"],
        "星空卫视": ["星空卫视", "星空衛视", "星空衛視"],
        "CHANNEL[V]": ["CHANNEL-V", "Channel[V]"],
        "凤凰卫视": ["凤凰卫视中文台", "凤凰中文", "凤凰卫视中文", "凤凰卫视"],
        "凤凰资讯": ["凤凰卫视资讯台", "凤凰资讯", "凤凰卫资讯"],
        "凤凰香港": ["凤凰香港台", "凤凰卫视香港", "凤凰香港"],
        "凤凰电影": ["凤凰电影", "凤凰电影台", "凤凰卫视电影", "凤凰卫视电影台", " 凤凰电影"],
        "北京IPTV4K超清": ["IPTV淘4K", "北京IPTV4K超清", "北京淘4K", "淘4K", "淘 4K"],
        "北京IPTV淘电影": ["IPTV淘电影", "淘电影", "北京淘电影"],
        "北京IPTV淘精彩": ["IPTV淘精彩", "淘精彩", "北京淘精彩"],
        "北京IPTV淘剧场": ["IPTV淘剧场", "淘剧场", "北京淘剧场"],
        "北京IPTV淘娱乐": ["IPTV淘娱乐", "淘娱乐", "北京淘娱乐"],
        "北京IPTV淘BABY": ["IPTV淘BABY", "淘BABY", "北京淘BABY", "IPTV淘baby", "北京IPTV淘baby", "北京淘baby"],
        "北京IPTV萌宠TV": ["IPTV淘萌宠", "北京IPTV萌宠TV", "北京淘萌宠","淘萌宠"],
        "北京卡酷少儿": ["卡酷少儿", "北京卡酷少儿", "卡酷动画","北京KAKU少儿","BRTV卡酷少儿"],
        "北京纪实科教": ["纪实科教", "北京纪实科教", "BRTV纪实科教", "纪实科教8K"],
        "朝阳区": ["朝阳融媒"],
        "通州区": ["通州融媒"],
        "房山区": ["房山电视台"],
        "密云区": ["密云电视台"],
        "延庆区": ["延庆电视台"],
        "广东岭南戏曲": ["岭南戏曲", "广东岭南戏曲"],
        "广东现代教育": ["现代教育", "广东现代教育"],
        "广东南方购物": ["南方购物", "广东南方购物"],
        "惠州综合频道": ["HZTV-1", "惠州综合频道"],
        "惠州公共频道": ["HZTV-2", "惠州公共频道"],
        "广东嘉佳卡通": ["嘉佳卡通", "广东嘉佳卡通"],
        "江苏优漫卡通": ["优漫卡通", "江苏优漫卡通"],
        "湖南金鹰纪实": ["金鹰纪实", "湖南金鹰纪实"],
        "湖南金鹰卡通": ["金鹰卡通","湖南金鹰卡通"],
        "湖南快乐垂钓": ["快乐垂钓","湖南快乐垂钓"],
        "湖南茶频道": ["茶频道","湖南茶频道"],
        "湖南先锋乒羽": ["先锋乒羽","湖南先锋乒羽"],
        "上海新闻综合": ["新闻综合"],
        "上海都市频道": ["都市频道"],
        "上海东方影视": ["东方影视"],
        "上海教育频道": ["上海教育"],
        "上海第一财经": ["第一财经", "上海第一财经"],
        "上海动漫秀场": ["动漫秀场", "上海动漫秀场"],
        "上海动漫秀场4K": ["动漫秀场4K"],
        "上海都市剧场": ["都市剧场", "上海都市剧场"],
        "上海都市剧场4K": ["都市剧场4K"],
        "上海东方财经": ["东方财经", "上海东方财经"],
        "上海法治天地": ["法治天地", "上海法治天地"],
        "上海游戏风云": ["游戏风云", "上海游戏风云"],
        "上海生活时尚": ["生活时尚", "上海生活时尚"],
        "上海金色学堂": ["金色学堂", "上海金色学堂"],
        "上海乐游频道": ["乐游","乐游频道", "上海乐游","上海乐游纪实"],
        "上海欢笑剧场": ["欢笑剧场", "上海欢笑剧场"],
        "上海欢笑剧场4K": ["欢笑剧场4K", "上海欢笑剧场4K"],
        "上海哈哈炫动": ["哈哈炫动","炫动卡通", "上海哈哈炫动"],
        "河南梨园频道": ["梨园","河南梨园频道"],
        "河南文物宝库": ["文物宝库","河南文物宝库"],
        "河南武术世界": ["武术世界","河南武术世界"],
        "河北农民": ["河北三农频道"],
        "魅力足球": ["魅力足球"],
        "天元围棋": ["天元围棋"],
        "中国天气": ["中国天气"],
        "中国交通": ["中国交通","中国交通频道"],
        "睛彩青少": ["睛彩羽毛球"],
        "睛彩竞技": ["睛彩竞技"],
        "睛彩篮球": ["睛彩篮球"],
        "睛彩广场舞": ["睛彩广场舞"],
        "求索纪录": ["求索记录"],
        "求索纪录4K": ["求索纪录4K", "求索记录4K", "求索纪录 4K", "求索记录 4K"],
        "成都综合频道": ["CDTV1综合"],
        "成都经济频道": ["CDTV2经济"],
        "成都生活频道": ["CDTV3生活"],
        "成都影视频道": ["CDTV4影视"],
        "成都公共频道": ["CDTV5公共"],
        "成都少儿频道": ["CDTV6少儿"],
        "黄河电视台": ["山西黄河频道"],
        "山西影视": ["山西影视频道"],
        "XJTV-1": ["新疆卫视"],
        "XJTV-2": ["新疆卫视2"],
        "XJTV-3": ["新疆卫视3"],
        "XJTV-4": ["新疆卫视4"],
        "XJTV-5": ["新疆卫视5"],
        "XJTV-6": ["新疆卫视6"],
        "XJTV-7": ["新疆卫视10"],
        "XJTV-8": ["新疆卫视12"],
        "海南公共频道": ["海南公共"],
        "海南少儿频道": ["海南少儿"],
        "海南文旅频道": ["海南文旅"],
        "海南新闻频道": ["海南新闻"],
        "海南自贸频道": ["海南自贸"],
        "海口1台": ["海口1"],
        "三亚1台": ["三亚1"],
        "澄迈TV": ["澄迈"],
        "贵州公共频道": ["贵州卫视2"],
        "贵州影视文艺": ["贵州卫视3"],
        "贵州大众生活": ["贵州卫视4"],
        "贵州法制频道": ["贵州卫视5"],
        "贵州科教健康": ["贵州卫视6"],
        "贵州经济频道": ["贵州卫视7"],
        "重庆新闻频道": ["重庆新闻频道"],
        "重庆影视剧频道": ["重庆影视剧频道"],
        "重庆社会与法": ["重庆社会与法"],
        "重庆红岩文化": ["重庆红岩文化","重庆时红岩文化"],
        "重庆文体娱乐": ["重庆文体娱乐"],
        "重庆新农村": ["重庆新农村","重庆新农村频道"],
        "重庆融媒": ["重广融媒"],
        "重庆少儿频道": ["重庆少儿频道"],
        "重庆红叶频道": ["重庆红叶频道"],
        "重庆汽摩频道": ["汽摩","汽摩频道","重庆汽摩","重庆汽摩频道"],
        "重庆移动频道": ["重庆移动频道"],
        "开州综合": ["开州综合"]
    }
    
    return CATEGORY_MAPPING, CHANNEL_NAME_MAPPING

def classify_channels(valid_groups, category_mapping, channel_name_mapping):
    """对频道进行分类 - 使用完整的频道分类规则"""
    classified_channels = {category: [] for category in category_mapping.keys()}
    
    print("开始频道重分类...")
    
    # 从有效分组生成频道列表
    channel_lines = []
    for group_name, channels in valid_groups.items():
        for channel_name, channel_url in channels:
            # 在播放地址后加入$所属组名
            channel_line = f"{channel_name},{channel_url}${group_name}"
            channel_lines.append(channel_line)
    
    print(f"共处理 {len(channel_lines)} 个频道")
    
    # 构建反向映射，便于快速查找
    reverse_category_map = {}
    for category, channels_in_category in category_mapping.items():
        for channel in channels_in_category:
            reverse_category_map[channel] = category
    
    # 构建别名到标准名称的映射
    alias_to_standard = {}
    for standard_name, aliases in channel_name_mapping.items():
        for alias in aliases:
            alias_to_standard[alias] = standard_name
    
    for line in channel_lines:
        line = line.strip()
        if not line:
            continue
            
        # 解析频道名称和完整信息
        if ',' in line:
            parts = line.split(',', 1)
            if len(parts) == 2:
                channel_name, rest = parts
                original_channel_name = channel_name.strip()
                
                # 1. 首先检查频道名称是否直接匹配分类中的标准名称
                found_category = reverse_category_map.get(original_channel_name)
                
                # 2. 如果没有直接匹配，使用频道名称映射规则标准化频道名称
                if not found_category:
                    # 查找别名映射
                    standard_name = alias_to_standard.get(original_channel_name)
                    if standard_name:
                        # 使用映射后的标准名称查找分类
                        found_category = reverse_category_map.get(standard_name)
                        print(f"频道映射: '{original_channel_name}' -> '{standard_name}' -> '{found_category}'")
                    else:
                        print(f"频道未匹配: '{original_channel_name}' -> 其他频道")
                
                # 3. 如果还没找到分类，放入"其他频道"
                if not found_category:
                    found_category = "其他频道,#genre#"
                
                # 将完整的行添加到对应分类
                classified_channels[found_category].append(line)
    
    # 统计各分类的频道数量
    for category, channels in classified_channels.items():
        print(f"分类 '{category}' 有 {len(channels)} 个频道")
    
    return classified_channels

def get_beijing_time():
    """获取北京时间（不使用pytz）"""
    # 获取UTC时间
    utc_now = datetime.utcnow()
    # 转换为北京时间（UTC+8）
    beijing_time = utc_now + timedelta(hours=8)
    return beijing_time.strftime('%Y-%m-%d %H:%M:%S')

def generate_reclassify_file(classified_channels, output_file):
    """生成reclassify.txt文件"""
    print(f"生成 {output_file}...")
    
    # 获取北京时间
    beijing_time = get_beijing_time()
    
    output_lines = [f"# 生成时间: {beijing_time} (北京时间)"]
    
    # 按照固定顺序输出分类
    category_order = [
        "央视频道,#genre#",
        "付费频道,#genre#", 
        "卫视频道,#genre#",
        "国际频道,#genre#",
        "北京频道,#genre#",
        "上海频道,#genre#",
        "天津频道,#genre#",
        "重庆频道,#genre#",
        "广东频道,#genre#",
        "山东频道,#genre#",
        "江苏频道,#genre#",
        "浙江频道,#genre#",
        "安徽频道,#genre#",
        "福建频道,#genre#",
        "江西频道,#genre#",
        "河南频道,#genre#",
        "湖北频道,#genre#",
        "湖南频道,#genre#",
        "河北频道,#genre#",
        "山西频道,#genre#",
        "内蒙古频道,#genre#",
        "辽宁频道,#genre#",
        "吉林频道,#genre#",
        "黑龙江频道,#genre#",
        "广西频道,#genre#",
        "海南频道,#genre#",
        "四川频道,#genre#",
        "贵州频道,#genre#",
        "云南频道,#genre#",
        "陕西频道,#genre#",
        "甘肃频道,#genre#",
        "青海频道,#genre#",
        "宁夏频道,#genre#",
        "新疆频道,#genre#",
        "其他频道,#genre#"
    ]
    
    for category in category_order:
        if category in classified_channels and classified_channels[category]:
            output_lines.append("")  # 空行分隔
            output_lines.append(category)  # 分类标题
            output_lines.extend(classified_channels[category])
    
    # 写入文件
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write('\n'.join(output_lines))
    
    total_channels = sum(len(channels) for channels in classified_channels.values())
    print(f"生成完成！总频道数: {total_channels}")
    return total_channels

def main():
    # 原始文件URL
    url = "https://raw.githubusercontent.com/q1017673817/iptvz/main/zubo_all.txt"
    
    try:
        print("=== 开始处理 ===")
        start_time = time.time()
        
        print("步骤1: 下载文件...")
        content = download_file(url)
        if not content:
            print("下载失败，退出")
            return
        
        print("步骤2: 处理内容...")
        lines = process_content(content)
        if not lines:
            print("处理内容后没有有效行，退出")
            return
        
        print("步骤3: 解析分组...")
        groups = parse_groups(lines)
        if not groups:
            print("没有解析出任何分组，退出")
            return
        
        print("步骤4: 多线程检测流有效性...")
        valid_groups = filter_valid_groups(groups, max_workers=10)
        if not valid_groups:
            print("没有有效的分组，退出")
            return
        
        print("步骤5: 加载频道分类映射...")
        category_mapping, channel_name_mapping = load_category_mapping()
        
        print("步骤6: 重分类频道生成reclassify.txt...")
        classified_channels = classify_channels(valid_groups, category_mapping, channel_name_mapping)
        total_channels = generate_reclassify_file(classified_channels, 'reclassify.txt')
        
        end_time = time.time()
        processing_time = end_time - start_time
        
        print(f"=== 完成！ ===")
        print(f"处理时间: {processing_time:.2f} 秒")
        print(f"有效分组: {len(valid_groups)} 个")
        print(f"总频道数: {total_channels} 个")
        print(f"生成文件: reclassify.txt")
        
    except Exception as e:
        print(f"错误: {e}")
        import traceback
        traceback.print_exc()
        exit(1)

if __name__ == "__main__":
    main()
 